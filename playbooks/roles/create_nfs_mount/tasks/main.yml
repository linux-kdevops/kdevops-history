---
- name: Import optional extra_args file
  include_vars: "{{ item }}"
  ignore_errors: yes
  with_first_found:
    - files:
      - "../extra_vars.yml"
      - "../extra_vars.yaml"
      - "../extra_vars.json"
      skip: true
  tags: vars

- name: Install NFS client administrative tools for {{ ansible_os_family }}
  tags: deps
  vars:
    packages:
      Debian:
        - "nfs-common"
      Suse:
        - "nfs-utils"
      RedHat:
        - "nfs-utils"
  become: true
  become_flags: 'su - -c'
  become_method: ansible.builtin.sudo
  ansible.builtin.package:
    name: "{{ packages[ansible_os_family] }}"
    state: present

- name: Check if {{ nfs_mounted_on }} is mounted
  become: yes
  become_method: sudo
  ansible.builtin.command: mountpoint -q {{ nfs_mounted_on }}
  register: mountpoint_stat
  failed_when: False
  changed_when: False

- name: Ensure {{ nfs_mounted_on }} is mounted
  become: yes
  become_flags: 'su - -c'
  become_method: sudo
  throttle: 1
  ansible.builtin.mount:
    path: "{{ nfs_mounted_on }}"
    src: "{{ nfs_server_hostname }}:{{ nfs_server_export }}"
    fstype: "nfs"
    opts: "{{ nfs_mount_options }}"
    state: mounted
  when:
    mountpoint_stat != 0
